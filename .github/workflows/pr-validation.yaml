name: PR Validation

on:
  pull_request:
    branches:
      - main
      - dev

jobs:
  validate-source-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Validate PR source branch
        run: |
          TARGET_BRANCH="${{ github.base_ref }}"
          SOURCE_BRANCH="${{ github.head_ref }}"

          echo "PR: $SOURCE_BRANCH ‚Üí $TARGET_BRANCH"
          echo ""

          # ============================================================
          # PRs to main: Only allow dev and hotfix/* branches
          # ============================================================
          if [ "$TARGET_BRANCH" = "main" ]; then
            # Allow dev branch (normal release workflow)
            if [ "$SOURCE_BRANCH" = "dev" ]; then
              echo "‚úÖ Release PR: dev ‚Üí main"
              exit 0
            fi

            # Allow hotfix/* branches (emergency production fixes)
            if [[ "$SOURCE_BRANCH" =~ ^hotfix/ ]]; then
              echo "‚úÖ Hotfix PR: $SOURCE_BRANCH ‚Üí main (emergency fix)"
              echo ""
              echo "‚ö†Ô∏è  REMINDER: After merging, sync hotfix back to dev:"
              echo "   git checkout dev && git merge main && git push origin dev"
              exit 0
            fi

            # Block feature/* branches
            if [[ "$SOURCE_BRANCH" =~ ^feature/ ]]; then
              echo "‚ùå Error: Feature branches cannot merge directly to main"
              echo "   Current: $SOURCE_BRANCH ‚Üí main"
              echo ""
              echo "Correct workflow:"
              echo "   1. Create PR: $SOURCE_BRANCH ‚Üí dev"
              echo "   2. After testing in dev, create release PR: dev ‚Üí main"
              exit 1
            fi

            # Block bugfix/* branches
            if [[ "$SOURCE_BRANCH" =~ ^bugfix/ ]]; then
              echo "‚ùå Error: Bugfix branches cannot merge directly to main"
              echo "   Current: $SOURCE_BRANCH ‚Üí main"
              echo ""
              echo "Correct workflow:"
              echo "   1. Create PR: $SOURCE_BRANCH ‚Üí dev (test with other changes)"
              echo "   2. After testing in dev, create release PR: dev ‚Üí main"
              echo ""
              echo "üí° TIP: For production emergencies, use hotfix/* branches instead"
              exit 1
            fi

            # Block any other branch
            echo "‚ùå Error: PRs to main must come from dev or hotfix/* branches"
            echo "   Current: $SOURCE_BRANCH ‚Üí main"
            echo ""
            echo "Allowed sources for main:"
            echo "   ‚Ä¢ dev (normal releases)"
            echo "   ‚Ä¢ hotfix/* (emergency production fixes)"
            exit 1
          fi

          # ============================================================
          # PRs to dev: Recommend feature/bugfix/refactor branches
          # ============================================================
          if [ "$TARGET_BRANCH" = "dev" ]; then
            # Allow main ‚Üí dev (syncing after hotfix)
            if [ "$SOURCE_BRANCH" = "main" ]; then
              echo "‚úÖ Sync PR: main ‚Üí dev (syncing hotfix)"
              exit 0
            fi

            # Check for standard branch prefixes
            if [[ "$SOURCE_BRANCH" =~ ^(feature|bugfix|refactor)/ ]]; then
              echo "‚úÖ Development PR: $SOURCE_BRANCH ‚Üí dev"
              exit 0
            fi

            # Warn about non-standard branch names
            echo "‚ö†Ô∏è  Warning: PRs to dev should use standard branch prefixes"
            echo "   Current: $SOURCE_BRANCH ‚Üí dev"
            echo ""
            echo "Recommended prefixes:"
            echo "   ‚Ä¢ feature/*  - New features"
            echo "   ‚Ä¢ bugfix/*   - Bug fixes"
            echo "   ‚Ä¢ refactor/* - Code improvements"
            echo ""
            echo "‚úÖ Validation passed (warning only)"
            exit 0
          fi

          echo "‚úÖ PR validation passed"
